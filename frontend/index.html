<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Triaje Virtual</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Manrope:wght@400;500;700;800&family=Newsreader:opsz,wght@6..72,500;6..72,700&display=swap");

    :root {
      --bg: #f3f6f8;
      --bg-2: #e9eff3;
      --ink: #10232f;
      --ink-soft: #4a6170;
      --brand: #1a6fa6;
      --brand-deep: #11507a;
      --card: #ffffff;
      --line: #d6e1e8;
      --chip: #ebf4fb;
      --chip-2: #eef2f5;
      --ok: #1c9b56;
      --warn: #d59514;
      --danger: #d84444;
      --shadow: 0 24px 50px rgba(16, 35, 47, 0.14);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: "Manrope", sans-serif;
      color: var(--ink);
      background:
        radial-gradient(1200px 500px at -8% -10%, #d7ecfb 0%, transparent 60%),
        radial-gradient(900px 450px at 110% 110%, #d6f5e9 0%, transparent 60%),
        linear-gradient(170deg, var(--bg) 0%, var(--bg-2) 100%);
      min-height: 100vh;
      padding: 28px 16px;
    }

    .shell {
      max-width: 980px;
      margin: 0 auto;
      animation: enter 0.55s ease-out both;
    }

    .panel {
      background: linear-gradient(160deg, rgba(255, 255, 255, 0.98), rgba(249, 252, 255, 0.95));
      border: 1px solid rgba(214, 225, 232, 0.85);
      border-radius: 24px;
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .hero {
      padding: 28px 28px 18px;
      border-bottom: 1px solid var(--line);
      background:
        radial-gradient(650px 220px at 0% 0%, rgba(26, 111, 166, 0.14) 0%, transparent 70%),
        radial-gradient(450px 200px at 100% 0%, rgba(28, 155, 86, 0.11) 0%, transparent 70%);
    }

    .eyebrow {
      display: inline-block;
      margin: 0;
      font-size: 12px;
      font-weight: 800;
      letter-spacing: 0.11em;
      text-transform: uppercase;
      color: var(--brand-deep);
      background: rgba(26, 111, 166, 0.12);
      border: 1px solid rgba(26, 111, 166, 0.2);
      border-radius: 999px;
      padding: 6px 10px;
    }

    h1 {
      margin: 14px 0 6px;
      font-family: "Newsreader", serif;
      font-size: clamp(2rem, 5vw, 2.8rem);
      line-height: 1.08;
      letter-spacing: -0.02em;
      color: #0c344f;
    }

    .lead {
      margin: 0;
      max-width: 72ch;
      color: var(--ink-soft);
      font-size: 15px;
      line-height: 1.6;
    }

    .workspace {
      display: grid;
      gap: 18px;
      padding: 22px 22px 24px;
    }

    .input-card,
    .result-card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 16px;
    }

    .label {
      margin: 0 0 10px;
      font-size: 13px;
      font-weight: 800;
      color: var(--ink-soft);
      letter-spacing: 0.04em;
      text-transform: uppercase;
    }

    textarea {
      width: 100%;
      min-height: 138px;
      border: 1px solid #c8d7e1;
      border-radius: 14px;
      padding: 13px 14px;
      font: inherit;
      font-size: 15px;
      line-height: 1.45;
      color: var(--ink);
      background: #fcfeff;
      resize: vertical;
      transition: border-color .2s ease, box-shadow .2s ease;
    }

    textarea:focus {
      outline: none;
      border-color: #76a9cc;
      box-shadow: 0 0 0 3px rgba(26, 111, 166, 0.16);
    }

    .actions {
      margin-top: 12px;
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 10px 14px;
    }

    .btn {
      border: 0;
      border-radius: 12px;
      padding: 12px 18px;
      font: inherit;
      font-weight: 800;
      color: #fff;
      background: linear-gradient(135deg, #1a6fa6, #11507a);
      box-shadow: 0 10px 22px rgba(17, 80, 122, 0.28);
      cursor: pointer;
      transition: transform .14s ease, box-shadow .14s ease, opacity .2s ease;
    }

    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 14px 26px rgba(17, 80, 122, 0.32);
    }

    .btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .hint {
      color: var(--ink-soft);
      font-size: 13px;
    }

    .result-card {
      display: none;
      animation: rise 0.32s ease-out both;
    }

    .result-card.is-visible {
      display: block;
    }

    .result-card h3 {
      margin: 14px 0 7px;
      font-size: 14px;
      font-weight: 800;
      letter-spacing: .03em;
      text-transform: uppercase;
      color: var(--ink-soft);
    }

    .chip,
    .categoria-chip {
      display: inline-block;
      margin: 4px 6px 4px 0;
      padding: 7px 12px;
      border-radius: 999px;
      font-size: 13px;
      font-weight: 700;
      line-height: 1.2;
    }

    .chip {
      background: var(--chip);
      color: #0c4265;
      border: 1px solid #d5e7f5;
    }

    .categoria-chip {
      background: var(--chip-2);
      color: #243844;
      border: 1px solid #dde7ed;
    }

    .prioridad1,
    .prioridad2,
    .prioridad3 {
      display: inline-block;
      margin: 4px 6px 4px 0;
      padding: 7px 10px;
      border-radius: 10px;
      font-size: 12px;
      font-weight: 800;
      color: #fff;
    }

    .prioridad1 { background: var(--ok); }
    .prioridad2 { background: var(--warn); }
    .prioridad3 { background: var(--danger); }

    .row {
      margin-top: 11px;
      font-size: 14px;
      line-height: 1.5;
    }

    .row strong {
      color: #0a3f62;
    }

    .accion-badge {
      display: inline-block;
      margin-top: 4px;
      padding: 8px 12px;
      border-radius: 10px;
      color: #fff;
      font-weight: 800;
      font-size: 13px;
      line-height: 1.3;
    }

    .error {
      color: #a32828;
      font-weight: 800;
    }

    @keyframes enter {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 720px) {
      .hero { padding: 22px 18px 16px; }
      .workspace { padding: 16px; }
      .input-card, .result-card { padding: 14px; }
      .actions { flex-direction: column; align-items: stretch; }
      .btn { width: 100%; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <section class="panel">
      <header class="hero">
        <p class="eyebrow">Evaluacion Inicial</p>
        <h1>Triaje Virtual</h1>
        <p class="lead">
          Describe tus sintomas con tus propias palabras. El sistema detecta sintomas clave,
          estima el nivel de urgencia y sugiere una accion inicial.
        </p>
      </header>

      <section class="workspace">
        <article class="input-card">
          <p class="label">Descripcion del paciente</p>
          <textarea id="entrada" placeholder="Ejemplo: tengo dolor de garganta, estornudos y lagrimeo desde ayer"></textarea>
          <div class="actions">
            <button id="btnAnalizar" class="btn" type="button">Analizar</button>
            <span class="hint">Atajo: Ctrl+Enter</span>
          </div>
        </article>

        <article id="resultado" class="result-card"></article>
      </section>
    </section>
  </main>

  <script>
    const ANALIZAR_URL = "/api/analizar";

    const entradaEl = document.getElementById("entrada");
    const resultadoEl = document.getElementById("resultado");
    const btnEl = document.getElementById("btnAnalizar");

    function escapeHtml(value) {
      return String(value)
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;");
    }

    function renderChips(items, cssClass) {
      return items.map((item) => `<span class="${cssClass}">${escapeHtml(item)}</span>`).join("");
    }

    function renderPrioridades(prioridades) {
      return Object.entries(prioridades)
        .map(([sintoma, nivel]) => {
          const clase = nivel === 1 ? "prioridad1" : nivel === 2 ? "prioridad2" : "prioridad3";
          return `<span class="${clase}">${escapeHtml(sintoma)}: ${escapeHtml(nivel)}</span>`;
        })
        .join("");
    }

    function renderCategorias(categorias) {
      return Object.entries(categorias)
        .map(([categoria, sintomas]) => {
          const nombre = escapeHtml(categoria);
          const chips = renderChips(sintomas, "categoria-chip");
          return `<div class="row"><strong>${nombre}:</strong> ${chips}</div>`;
        })
        .join("");
    }

    async function analizar() {
      const entrada = entradaEl.value.trim();
      resultadoEl.classList.add("is-visible");

      if (!entrada) {
        resultadoEl.innerHTML = `<p class="error">Escribe sintomas antes de analizar.</p>`;
        return;
      }

      btnEl.disabled = true;
      resultadoEl.innerHTML = `<p class="row"><strong>Analizando...</strong></p>`;

      try {
        const resp = await fetch(ANALIZAR_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ texto_paciente: entrada })
        });

        if (!resp.ok) {
          const t = await resp.text();
          resultadoEl.innerHTML = `<p class="error">Error ${resp.status}: ${escapeHtml(t)}</p>`;
          return;
        }

        const data = await resp.json();
        const sintomas = data.sintomas || [];
        const categorias = data.categorias || {};
        const prioridades = data.prioridades || {};
        const urgencia = data.overall_urgency ?? 0;
        const recomendacion = data.recommended_action || "Sin recomendacion.";

        if (!sintomas.length) {
          resultadoEl.innerHTML = `<p class="row"><strong>${escapeHtml(recomendacion)}</strong></p>`;
          return;
        }

        const sintomasHTML = renderChips(sintomas, "chip");
        const categoriasHTML = renderCategorias(categorias);
        const prioridadesHTML = renderPrioridades(prioridades);
        const claseUrgencia = urgencia === 1 ? "prioridad1" : urgencia === 2 ? "prioridad2" : "prioridad3";
        const accionBadgeClass = `accion-badge ${claseUrgencia}`;

        resultadoEl.innerHTML = `
          <h3>Sintomas detectados</h3>
          <div>${sintomasHTML}</div>
          <h3>Categorias</h3>
          ${categoriasHTML || "<p class='row'>Sin categorias.</p>"}
          <h3>Prioridades</h3>
          <div>${prioridadesHTML || "<p class='row'>Sin prioridades.</p>"}</div>
          <p class="row">Nivel global de urgencia: <strong>${escapeHtml(urgencia)}</strong></p>
          <p class="row"><strong>Accion recomendada:</strong></p>
          <span class="${accionBadgeClass}">${escapeHtml(recomendacion)}</span>
        `;
      } catch (err) {
        resultadoEl.innerHTML = `<p class="error">Error de conexion: ${escapeHtml(err)}</p>`;
      } finally {
        btnEl.disabled = false;
      }
    }

    btnEl.addEventListener("click", analizar);
    entradaEl.addEventListener("keydown", (event) => {
      if (event.ctrlKey && event.key === "Enter") {
        analizar();
      }
    });
  </script>
</body>
</html>
